<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Leave Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-100 min-h-screen p-8">
<div class="flex h-screen">
    <div th:replace="usersidebar :: userSidebarFragment"></div>

    <!-- Leave Application Form -->
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-8">
        <h1 class="text-3xl font-bold text-center mb-6">Leave Application</h1>

        <form class="space-y-6" id="leave-form">

            <!-- Employee Details -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-gray-600" for="employee-name">Employee Name</label>
                    <input class="w-full p-3 border border-gray-300 rounded-md" id="employee-name" name="employee-name"
                           placeholder="Enter your name" readonly type="text">
                </div>
                <div>
                    <label class="block text-gray-600" for="employee-id">Employee ID</label>
                    <input class="w-full p-3 border border-gray-300 rounded-md" id="employee-id" name="employee-id"
                           placeholder="Enter your ID" readonly type="text">
                </div>
            </div>

            <!-- Leave Type -->
            <div>
                <label class="block text-gray-600" for="leave-type">Leave Type</label>
                <select class="w-full p-3 border border-gray-300 rounded-md" id="leave-type" name="leave-type" required>
                    <option disabled selected value="">Select Leave Type</option>
                    <option value="sick">Sick Leave</option>
                    <option value="casual">Casual Leave</option>
                    <option value="vacation">Vacation Leave</option>
                    <option value="maternity">Maternity Leave</option>
                    <option value="paternity">Paternity Leave</option>
                </select>
            </div>

            <!-- Leave Dates -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-600" for="start-date">Leave Start Date</label>
                    <input class="w-full p-3 border border-gray-300 rounded-md" id="start-date" name="start-date" required type="date">
                </div>
                <div>
                    <label class="block text-gray-600" for="end-date">Leave End Date</label>
                    <input class="w-full p-3 border border-gray-300 rounded-md" id="end-date" name="end-date" required type="date">
                </div>
            </div>

            <!-- Reason for Leave -->
            <div>
                <label class="block text-gray-600" for="leave-reason">Reason for Leave</label>
                <textarea class="w-full p-3 border border-gray-300 rounded-md" id="leave-reason" name="leave-reason" placeholder="Enter the reason for your leave"
                          rows="4"></textarea>
            </div>

            <!-- Submit Button -->
            <div class="text-center">
                <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition" type="submit">
                    Submit Application
                </button>
            </div>
        </form>
    </div>
</div>

<!-- JS Section -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("token"); // Ensure key is lowercase "token"

        fetch("http://localhost:8080/api/user/userdata", {
            method: "GET",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            }
        })
        .then(response => {
            if (response.status === 401) {
                alert("Session expired. Please log in again.");
                window.location.href = "/user-login";
                return;
            }
            if (!response.ok) {
                throw new Error("HTTP status " + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log("User data:", data);

            // Auto-fill the name and ID fields
            document.getElementById("employee-name").value = data.username || "N/A";
            document.getElementById("employee-id").value = data.id || "N/A";
        })
        .catch(error => {
            console.error("Error fetching user data:", error);
        });
    });

    document.getElementById('leave-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission

        const token = localStorage.getItem("token");

        if (!token) {
            alert('No token found. Please log in.');
            return;
        }

        // Gather form data
        const formData = {
            employee_name: document.getElementById('employee-name').value,
            employee_id: document.getElementById('employee-id').value,
            leave_type: document.getElementById('leave-type').value,
            start_date: document.getElementById('start-date').value,
            end_date: document.getElementById('end-date').value,
            leave_reason: document.getElementById('leave-reason').value
        };

        fetch('http://localhost:8080/api/user/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (response.ok) {
                alert('Leave application submitted successfully!');
                document.getElementById('leave-form').reset();
            } else {
                throw new Error('Failed to submit application');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error submitting leave application. Please try again.');
        });
    });
</script>

</body>
</html>
